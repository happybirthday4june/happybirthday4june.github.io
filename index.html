<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feliz Aniversário, Dasha!</title>
    <script src="https://cdn.jsdelivr.net/npm/opensheetmusicdisplay@1.5.0/build/opensheetmusicdisplay.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/soundfont-player@0.12.6/dist/soundfont-player.min.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #ff9a9e, #fad0c4);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            color: #333;
            text-align: center;
        }
        
        header {
            padding: 30px;
            width: 100%;
            background-color: rgba(255,255,255,0.2);
        }
        
        h1 {
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        #partitura-container {
            width: 90%;
            max-width: 600px;
            height: 250px;
            margin: 20px auto;
            border: 1px solid #ddd;
            background-color: white;
            border-radius: 10px;
            overflow: auto;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        button {
            padding: 12px 24px;
            background-color: #ff6b6b;
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 18px;
            cursor: pointer;
            margin: 20px 0;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        button:hover {
            background-color: #ff5252;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        #loading {
            margin: 20px 0;
            color: white;
        }
        
        #error-message {
            color: #ff3333;
            background-color: rgba(255,255,255,0.8);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
        }
        
        .mensagem-aniversario {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3em;
            color: #ff6b6b;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            opacity: 0;
            z-index: 100;
            animation: aparecer 4s ease-in-out;
            font-weight: bold;
        }
        
        @keyframes aparecer {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.5); }
            20% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
            40% { transform: translate(-50%, -50%) scale(1); }
            80% { opacity: 1; }
            100% { opacity: 0; }
        }
    </style>
</head>
<body>
    <header>
        <h1>Feliz Aniversário, Dasha!</h1>
        <p>Uma surpresa musical para a melhor professora de piano</p>
    </header>
    
    <div id="partitura-container"></div>
    
    <div id="loading">Carregando piano virtual...</div>
    
    <div id="error-message">
        Ocorreu um erro ao carregar os recursos. Por favor, recarregue a página.
        <button onclick="window.location.reload()" style="margin-top: 10px;">Recarregar</button>
    </div>
    
    <button id="btnTocar" disabled>Tocar Parabéns</button>
    
    <script>
        // Variáveis globais
        let audioContext;
        let instrument;
        let osmd;
        
        // Inicialização quando a página carrega
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // 1. Inicializar AudioContext
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // Solução para bloqueio de autoplay
                document.body.addEventListener('click', () => {
                    if (audioContext.state === 'suspended') {
                        audioContext.resume();
                    }
                }, { once: true });
                
                // 2. Carregar instrumento de piano
                instrument = await Soundfont.instrument(audioContext, 'acoustic_grand_piano', {
                    soundfont: 'MusyngKite',
                    onprogress: (state, progress) => {
                        document.getElementById('loading').textContent = 
                            `Carregando piano... ${Math.round(progress * 100)}%`;
                    }
                });
                
                // 3. Configurar visualizador de partitura
                osmd = new opensheetmusicdisplay.OpenSheetMusicDisplay("partitura-container", {
                    backend: "svg",
                    drawTitle: true,
                    drawingParameters: "compacttight"
                });
                
                // 4. Carregar partitura de exemplo (Happy Birthday)
                await carregarPartitura();
                
                // 5. Ativar botão
                document.getElementById('btnTocar').disabled = false;
                document.getElementById('loading').style.display = 'none';
                
            } catch (error) {
                console.error("Erro ao carregar recursos:", error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error-message').style.display = 'block';
            }
        });
        
        // Função para carregar partitura de exemplo
        async function carregarPartitura() {
            const musicXml = `<?xml version="1.0" encoding="UTF-8"?>
            <!DOCTYPE score-partwise PUBLIC "-//Recordare//DTD MusicXML 3.1 Partwise//EN" "http://www.musicxml.org/dtds/partwise.dtd">
            <score-partwise version="3.1">
                <part-list>
                    <score-part id="P1">
                        <part-name>Piano</part-name>
                    </score-part>
                </part-list>
                <part id="P1">
                    <!-- Happy Birthday simplificado -->
                    <measure number="1">
                        <attributes>
                            <divisions>24</divisions>
                            <key><fifths>0</fifths></key>
                            <time><beats>3</beats><beat-type>4</beat-type></time>
                            <clef><sign>G</sign><line>2</line></clef>
                        </attributes>
                        <note><pitch><step>G</step><octave>4</octave></pitch><duration>12</duration><type>eighth</type></note>
                        <note><pitch><step>G</step><octave>4</octave></pitch><duration>12</duration><type>eighth</type></note>
                        <note><pitch><step>A</step><octave>4</octave></pitch><duration>24</duration><type>quarter</type></note>
                    </measure>
                    <measure number="2">
                        <note><pitch><step>G</step><octave>4</octave></pitch><duration>24</duration><type>quarter</type></note>
                        <note><pitch><step>C</step><octave>5</octave></pitch><duration>24</duration><type>quarter</type></note>
                    </measure>
                    <measure number="3">
                        <note><pitch><step>B</step><octave>4</octave></pitch><duration>48</duration><type>half</type></note>
                    </measure>
                </part>
            </score-partwise>`;
            
            await osmd.load(musicXml);
            await osmd.render();
            osmd.zoom = 0.7;
            osmd.update();
        }
        
        // Botão para tocar música
        document.getElementById('btnTocar').addEventListener('click', () => {
            tocarMusica();
            mostrarMensagem();
        });
        
        // Função para tocar a música
        function tocarMusica() {
            const btn = document.getElementById('btnTocar');
            btn.disabled = true;
            btn.textContent = "Tocando...";
            
            // Obter notas da partitura
            const notes = osmd.sheet.sourceMeasures[0].verticalSourceStaffEntryContainers
                .flatMap(container => container.sourceStaffEntries)
                .flatMap(entry => entry.notes)
                .filter(note => !!note.pitch);
            
            // Configuração do tempo
            const bpm = 100;
            const segundosPorPulso = 60 / bpm;
            
            // Tocar cada nota
            notes.forEach((note, index) => {
                const nota = note.pitch.step + note.pitch.octave;
                const startTime = audioContext.currentTime + (index * segundosPorPulso);
                
                instrument.play(nota, startTime, {
                    duration: note.length.value * segundosPorPulso,
                    gain: 0.3
                });
            });
            
            // Reativar botão após tocar
            setTimeout(() => {
                btn.disabled = false;
                btn.textContent = "Tocar Novamente";
            }, notes.length * segundosPorPulso * 1000);
        }
        
        // Mostrar mensagem de aniversário
        function mostrarMensagem() {
            const mensagem = document.createElement('div');
            mensagem.className = 'mensagem-aniversario';
            mensagem.textContent = 'Feliz Aniversário, Dasha!';
            document.body.appendChild(mensagem);
            
            setTimeout(() => {
                mensagem.remove();
            }, 4000);
        }
    </script>
</body>
</html>